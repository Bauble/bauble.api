language: python
python:
  - "3.3"
# command to install dependencies
install:
  # - "pip install . --use-mirrors"
  - "pip install pytest --use-mirrors"
  - "pip install -r requirements.txt --use-mirrors"
# command to run tests
script: py.test
env:
  - DATABASE_URL="postgresql://test:test@localhost/bauble" BAUBLE_ENV="development"
before_script:
  # the DATABASE_URL isn't getting picked up in the environment
  - echo "DATABASE_URL=postgresql://test:test@localhost/bauble" > ~/.bauble.api
  - sudo adduser -disabled-password --gecos "" bauble
  - psql -c 'create database bauble;' -U postgres
  - psql -c "create role test with login password 'test\';" -U postgres bauble
  #- python run.py &  # TODO: start uwsgi same as on production server, can we sudo here?
  - sudo $VIRTUAL_ENV/bin/uwsgi --ini uwsgi.ini:travis &
  - PYTHONPATH=. bin/initdb.py
  - PYTHONPATH=. bin/set_admin_password.py test
  - PYTHONPATH=. bin/create_test_org.py